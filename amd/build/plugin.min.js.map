{"version":3,"file":"plugin.min.js","sources":["../src/plugin.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Tiny tiny_html for Moodle.\n *\n * @module      tiny_html/plugin\n * @copyright   2023 Matt Porritt <matt.porritt@moodle.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {getTinyMCE} from 'editor_tiny/loader';\nimport {getPluginMetadata} from 'editor_tiny/utils';\n\nimport {component, pluginName, codeMirrorStyle} from './common';\nimport {html_beautify} from './beautify/beautify-html';\n\nimport {\n    EditorState,\n    EditorView,\n    basicSetup,\n    lang,\n} from './codemirror-lazy';\n\n/**\n * Options for the html_beautify function.\n */\nconst beautifyOptions = {\n    indent_size: 2,\n    wrap_line_length: 80,\n    unformatted: [],\n};\n\n/**\n * Configuration for TinyMCE editor the windowManager.\n */\nconst windowManagerConfig = {\n    title: 'Source code',\n    size: 'large',\n    body: {\n        type: 'panel',\n        items: [\n            {\n                type: 'htmlpanel',\n                html: '<div id=\"codeMirrorContainer\" style=\"height: 100%;\"></div>',\n            },\n        ],\n    },\n    buttons: [\n        {\n            type: 'cancel',\n            text: 'Cancelzzz',\n        },\n        {\n            type: 'submit',\n            text: 'Save',\n            primary: true,\n        },\n    ],\n    initialData: null,\n    onSubmit: null,\n};\n\n// Setup the tiny_html Plugin.\nexport default new Promise(async(resolve) => {\n    // Note: The PluginManager.add function does not support asynchronous configuration.\n    // Perform any asynchronous configuration here, and then call the PluginManager.add function.\n    const [\n        tinyMCE,\n        pluginMetadata,\n    ] = await Promise.all([\n        getTinyMCE(),\n        getPluginMetadata(component, pluginName),\n    ]);\n\n    // Reminder: Any asynchronous code must be run before this point.\n    tinyMCE.PluginManager.add(pluginName, (editor) => {\n        // Overriding the default 'mceCodeEditor' command\n        editor.addCommand('mceCodeEditor', () => {\n            // Get the current content of the editor\n            const content = editor.getContent({source_view: true});\n\n            // Beautify the content using html_beautify\n            const beautifiedContent = html_beautify(content, beautifyOptions);\n\n            // Create the CodeMirror instance\n            let cmInstance;\n\n            let state = EditorState.create({\n                doc: beautifiedContent,\n                // This is where basicSetup should go as [basicSetup, ...].\n                extensions: [\n                    basicSetup,\n                    EditorState.tabSize.of(2),\n                    // Bring in all language extensions.\n                    ...Object.entries(lang).map(([, languagePlugin]) => languagePlugin()),\n                ],\n            });\n\n            // Create a new window to display the beautified code\n            editor.windowManager.open({\n                ...windowManagerConfig,\n                onSubmit: (api) => {\n                    const cmContent = cmInstance.state.doc.toString();\n                    editor.setContent(cmContent, {source_view: true});\n                    api.close();\n                },\n            });\n\n            const container = document.getElementById('codeMirrorContainer');\n            // Create a shadow root for the CodeMirror instance.\n            // This is required to prevent the TinyMCE editor styles from overriding the CodeMirror ones.\n            const shadowRoot = container.attachShadow({mode: \"open\"});\n\n            // Add the styles to the shadow root\n            const style = document.createElement('style');\n            style.textContent = codeMirrorStyle;\n            shadowRoot.appendChild(style);\n\n            // Create a new div and add the class 'my-codemirror-container'\n            const div = document.createElement('div');\n            div.classList.add('modal-codemirror-container');\n            shadowRoot.appendChild(div);\n\n            // Create the CodeMirror instance\n            cmInstance = new EditorView({\n                state,\n                parent: div,\n            });\n\n            // Add an event listener to the shadow root to listen for the tab key press.\n            shadowRoot.addEventListener('keydown', (event) => {\n                // If the tab key is pressed, prevent the default action and select the cancel button.\n                // We need to do this as the shadow root is not part of the DOM, so the tab key will not\n                // be caught by the TinyMCE dialog.\n                if (event.key === 'Tab') {\n                    event.preventDefault();\n                    const codeMirrorContainer = document.getElementById('codeMirrorContainer');\n                    const dialogElement = codeMirrorContainer.closest('.tox-dialog');\n                    const cancelButton = dialogElement.querySelector('button[title=\"Cancelzzz\"]');\n                    cancelButton.focus();\n                }\n            });\n\n        });\n        // Return the pluginMetadata object. This is used by TinyMCE to display a help link for your plugin.\n        return pluginMetadata;\n    });\n\n    resolve(pluginName);\n});\n"],"names":["beautifyOptions","indent_size","wrap_line_length","unformatted","windowManagerConfig","title","size","body","type","items","html","buttons","text","primary","initialData","onSubmit","Promise","async","tinyMCE","pluginMetadata","all","component","pluginName","PluginManager","add","editor","addCommand","content","getContent","source_view","beautifiedContent","cmInstance","state","EditorState","create","doc","extensions","basicSetup","tabSize","of","Object","entries","lang","map","_ref","languagePlugin","windowManager","open","api","cmContent","toString","setContent","close","shadowRoot","document","getElementById","attachShadow","mode","style","createElement","textContent","codeMirrorStyle","appendChild","div","classList","EditorView","parent","addEventListener","event","key","preventDefault","closest","querySelector","focus","resolve"],"mappings":";;;;;;;;MAuCMA,gBAAkB,CACpBC,YAAa,EACbC,iBAAkB,GAClBC,YAAa,IAMXC,oBAAsB,CACxBC,MAAO,cACPC,KAAM,QACNC,KAAM,CACFC,KAAM,QACNC,MAAO,CACH,CACID,KAAM,YACNE,KAAM,gEAIlBC,QAAS,CACL,CACIH,KAAM,SACNI,KAAM,aAEV,CACIJ,KAAM,SACNI,KAAM,OACNC,SAAS,IAGjBC,YAAa,KACbC,SAAU,mBAIC,IAAIC,SAAQC,MAAAA,gBAInBC,QACAC,sBACMH,QAAQI,IAAI,EAClB,yBACA,4BAAkBC,kBAAWC,sBAIjCJ,QAAQK,cAAcC,IAAIF,oBAAaG,SAEnCA,OAAOC,WAAW,iBAAiB,WAEzBC,QAAUF,OAAOG,WAAW,CAACC,aAAa,IAG1CC,mBAAoB,+BAAcH,QAAS3B,qBAG7C+B,WAEAC,MAAQC,4BAAYC,OAAO,CAC3BC,IAAKL,kBAELM,WAAY,CACRC,2BACAJ,4BAAYK,QAAQC,GAAG,MAEpBC,OAAOC,QAAQC,sBAAMC,KAAIC,YAAIC,4BAAoBA,uBAK5DpB,OAAOqB,cAAcC,KAAK,IACnB3C,oBACHW,SAAWiC,YACDC,UAAYlB,WAAWC,MAAMG,IAAIe,WACvCzB,OAAO0B,WAAWF,UAAW,CAACpB,aAAa,IAC3CmB,IAAII,iBAONC,WAHYC,SAASC,eAAe,uBAGbC,aAAa,CAACC,KAAM,SAG3CC,MAAQJ,SAASK,cAAc,SACrCD,MAAME,YAAcC,wBACpBR,WAAWS,YAAYJ,aAGjBK,IAAMT,SAASK,cAAc,OACnCI,IAAIC,UAAUxC,IAAI,8BAClB6B,WAAWS,YAAYC,KAGvBhC,WAAa,IAAIkC,2BAAW,CACxBjC,MAAAA,MACAkC,OAAQH,MAIZV,WAAWc,iBAAiB,WAAYC,WAIlB,QAAdA,MAAMC,IAAe,CACrBD,MAAME,iBACsBhB,SAASC,eAAe,uBACVgB,QAAQ,eACfC,cAAc,6BACpCC,eAMlBtD,kBAGXuD,QAAQpD"}